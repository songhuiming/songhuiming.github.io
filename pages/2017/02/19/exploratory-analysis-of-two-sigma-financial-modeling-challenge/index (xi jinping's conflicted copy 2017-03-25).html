<!DOCTYPE html>
<html lang="en">
<head>
          <title>pydata</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="pydata Full Atom Feed" />
        <link href="/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="pydata Categories Atom Feed" />



    <meta name="tags" content="python" />
    <meta name="tags" content="data visualization" />
    <meta name="tags" content="matplotlib" />
    <meta name="tags" content="data minging" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">pydata <strong>Keep Looking, Don't Settle</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/functions/archives.html">Archives</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/pages/2017/02/19/exploratory-analysis-of-two-sigma-financial-modeling-challenge/" rel="bookmark"
         title="Permalink to Exploratory analysis of Two Sigma Financial Modeling Challenge">Exploratory analysis of Two Sigma Financial Modeling Challenge</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2017-02-19T00:00:00-06:00">
      Sun 19 February 2017
    </abbr>
    <abbr class="modified" title="2017-02-19T00:00:00-06:00">
      Sun 19 February 2017
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="/author/huiming-song.html">Huiming Song</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>The data is time-varying value for each instrument. Each instrument has id, and timestamp. y is the response value to be predicted. All the others are the anonymized features.</p>
<h2>0. Introduction</h2>
<p>This dataset contains anonymized features pertaining to a time-varying value for a financial instrument. Each instrument has an id. Time is represented by the 'timestamp' feature and the variable to predict is 'y'. No further information will be provided on the meaning of the features, the transformations that were applied to them, the timescale, or the type of instruments that are included in the data. Moreover, in accordance with competition rules, participants must not use data other than the data linked from the competition website for the purpose of use in this competition to develop and test their models and submissions.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="s1">r&#39;../input/train.h5&#39;</span><span class="p">)</span>   
</pre></div>


<h2>1. data description</h2>
<p>First we will have a look how many columns are there in the data, what are the columns. How many data are there totally, How many isstrements are there(unique id), and how many timestamp observed for each instrement.</p>
<div class="highlight"><pre><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>


<div class="highlight"><pre>Index([u&#39;id&#39;, u&#39;timestamp&#39;, u&#39;derived_0&#39;, u&#39;derived_1&#39;, u&#39;derived_2&#39;,
       u&#39;derived_3&#39;, u&#39;derived_4&#39;, u&#39;fundamental_0&#39;, u&#39;fundamental_1&#39;,
       u&#39;fundamental_2&#39;,
       ...
       u&#39;technical_36&#39;, u&#39;technical_37&#39;, u&#39;technical_38&#39;, u&#39;technical_39&#39;,
       u&#39;technical_40&#39;, u&#39;technical_41&#39;, u&#39;technical_42&#39;, u&#39;technical_43&#39;,
       u&#39;technical_44&#39;, u&#39;y&#39;],
      dtype=&#39;object&#39;, length=111)
</pre></div>


<p>it is like the columns are fake names. it tells us 5 are  derived, 63 are fundamental, ant 40 are techinical.</p>
<div class="highlight"><pre><span class="n">cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">8</span><span class="p">]))</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fundmental columns: {}, Techinical columns: {}, Derived columns: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cols</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre>Fundmental columns: 63, Techinical columns: 40, Derived columns: 5
</pre></div>


<p>There are 1424 unique instrument id. Each id has unique timestamps. The instruments like id=1229, 1893 only has two timestamps. The instruments id = 1066, 704 have 1813 timestamps.</p>
<div class="highlight"><pre><span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="k">print</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="k">print</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>1424
id
1229     2
1893     2
435      2
1056     8
980     12
dtype: int64
id
1066    1813
704     1813
697     1813
699     1813
1548    1813
dtype: int64
</pre></div>


<h3>1.1. check the missing data</h3>
<p>Col 3 to col 110 are the independent variables. Most of these columns have missing values. The following is to count how many missing values are there for each variable and the percentage of missing values. The top 5 variables having the most missing values are fundamental_5 (56%), fundamental_38(47%), fundamental_6(41%), fundamental_1(40%) and fundamental_61(39%).</p>
<p>So we need to impute missing values. shall we impute directly or shall we impute within each group by id, timestamp or id+timestamp?</p>
<div class="highlight"><pre><span class="n">missing_cnts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">missing_pct</span> <span class="o">=</span> <span class="n">missing_cnts</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span class="n">missing_pct</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>fundamental_5     0.562336
fundamental_38    0.469669
fundamental_6     0.410126
fundamental_1     0.396941
fundamental_61    0.392692
dtype: float64
</pre></div>


<div class="highlight"><pre><span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
<span class="n">rects</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">missing_pct</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="p">((</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">missing_cnts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Percentage of missing values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Number of missing values in each column&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="/figures/20170218_twosigma_01.png" /></p>
<h3>1.2. y variable</h3>
<p>y distribution is like normal distribution, except that there are two high tails. We need to have a look why there are ourliers on the tail around 0.0934 and -0.086. It shows the data bas been capped and floored.</p>
<p>Then the questions comes: how shall we deal with the outliers? shall we use it directly or shall we do any transformation, even cap/floor again, flag it or delete it? These should be tested to check which way will be better.</p>
<div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of y&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre>&lt;matplotlib.text.Text at 0x1067c978&gt;
</pre></div>


<p><img alt="png" src="/figures/20170218_twosigma_02.png" /></p>
<p>When check which ids have the outliers, it is like most id have the extreme values. It is 1284 of 1424 instruments have the outliers.</p>
<div class="highlight"><pre><span class="k">print</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(y &gt;= 0.0934) | (y &lt;= -0.0860)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre>count    1.710756e+06
mean     2.217509e-04
std      2.240643e-02
min     -8.609413e-02
25%     -9.561389e-03
50%     -1.570681e-04
75%      9.520990e-03
max      9.349781e-02
Name: y, dtype: float64
1284
</pre></div>


<p>Take some instruments with outliers as example to plot y v.s. timestamp, there is the trend that at the starting time the data is more volatile, and it shows converging trend around 0. When the data converges to 0, the instrument will be stopped.</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(y &gt;= 0.0934) | (y &lt;= -0.0860)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">df_sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;id == @i&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_sel</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">df_sel</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="/figures/20170218_twosigma_03.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_04.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_05.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_06.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_07.png" /></p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(y &gt;= 0.0934) | (y &lt;= -0.0860)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="k">print</span> <span class="n">i</span>
    <span class="n">df_sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;id == @i&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_sel</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;distribution of id = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>93
419
961
1564
1659
</pre></div>


<p><img alt="png" src="/figures/20170218_twosigma_08.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_09.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_10.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_11.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_12.png" /></p>
<h3>1.3. timestamp</h3>
<p>The next variable to study is timestamp. It indicates each transaction for each instrument. We will check the frequency of timestamp first. This will help us to understand at what time there are more transactions and when there are less transactions.</p>
<div class="highlight"><pre><span class="n">timestamp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">timestamp</span>
</pre></div>


<div class="highlight"><pre><span class="k">for</span> <span class="n">bins</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;data counts&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of timestamp: {} bins&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bins</span><span class="p">))</span>
</pre></div>


<p><img alt="png" src="/figures/20170218_twosigma_13.png" /></p>
<p><img alt="png" src="/figures/20170218_twosigma_14.png" /></p>
<p>It shows there is period of the counts data by timestamp. In each period the counts will slightl decrease and then it will jump. The interval is about 100. So is it daily transaction and there are about 100 timestamps everyday?</p>
<h3>1.4. Summary of data</h3>
<ol>
<li>
<p>There are 1424 unique id in the data, and there are 1813 unique timestamp in the data. within each id, the timestamp is unique.</p>
</li>
<li>
<p>some id only has a few transactions, while some id has more than 1000 transactions.</p>
</li>
<li>
<p>many independent variables has missing values. we need to impute missing values.</p>
</li>
</ol>
<div class="highlight"><pre><span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre>1424
1813
</pre></div>


<h2>2. More check of the data</h2>
<h3>2.1. is the timestamp unique for each instrument?</h3>
<p>First I want to check for each id, if there are duplicated timestamp or not. The result shows there is no duplicated timestamp for each id. The way to do is group by each id, then compare the length of the subgroup and the counts of unique timestamp at each subgroup. we can define two functions and apply multiple self defined functons on the groupby object.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">unique</span><span class="p">())]</span>

<span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;uniq_cnt&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>

<span class="k">print</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="k">print</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>id
0     [1646, 1646]
6       [728, 728]
7     [1543, 1543]
10      [116, 116]
11    [1813, 1813]
dtype: object


id
0     {u&#39;shape&#39;: (1646, 111), u&#39;uniq_cnt&#39;: 1646}
6       {u&#39;shape&#39;: (728, 111), u&#39;uniq_cnt&#39;: 728}
7     {u&#39;shape&#39;: (1543, 111), u&#39;uniq_cnt&#39;: 1543}
10      {u&#39;shape&#39;: (116, 111), u&#39;uniq_cnt&#39;: 116}
11    {u&#39;shape&#39;: (1813, 111), u&#39;uniq_cnt&#39;: 1813}
dtype: object
</pre></div>


<p>it shows in each id, the timestamp is unique. That is, there is only one obs for each id at each timestamp.</p>
<h3>2.2. a little more about y and x</h3>
<p>This is to show how to apply multiple funcitons on different columns. for y, we will calculate min, max and median within each instrument. for timestamp, check its counts; for a given x technical_40, calculate its non-null mean in each instrument to impute the missing values.</p>
<div class="highlight"><pre><span class="n">f0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">x</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">],</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="s1">u&#39;technical_40&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fake name&#39;</span><span class="p">:</span> <span class="n">f0</span><span class="p">}}</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">y</th>
      <th>timestamp</th>
      <th>technical_40</th>
    </tr>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>median</th>
      <th>size</th>
      <th>fake name</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.086094</td>
      <td>0.093498</td>
      <td>0.000147</td>
      <td>1646</td>
      <td>-0.071997</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.075099</td>
      <td>0.057635</td>
      <td>-0.000100</td>
      <td>728</td>
      <td>-0.091534</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-0.086094</td>
      <td>0.093498</td>
      <td>-0.000009</td>
      <td>1543</td>
      <td>-0.079504</td>
    </tr>
    <tr>
      <th>10</th>
      <td>-0.086094</td>
      <td>0.093498</td>
      <td>-0.002115</td>
      <td>116</td>
      <td>-0.471554</td>
    </tr>
    <tr>
      <th>11</th>
      <td>-0.086094</td>
      <td>0.070152</td>
      <td>-0.000262</td>
      <td>1813</td>
      <td>-0.115141</td>
    </tr>
  </tbody>
</table>
</div>

<h3>2.3. impute missing by median in each id group</h3>
<p>As we shown above, lots of the x has missing values. A simple way to impute the missing value is its median. Here I will show how to impute all the missing values by the median value for each instrument, rather than using the median of the full data set.</p>
<div class="highlight"><pre><span class="n">fimpute</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

<span class="n">grp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fimpute</span><span class="p">)</span>

<span class="k">print</span> <span class="n">grp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>           id  timestamp  derived_0  derived_1  derived_2  derived_3  \
id                                                                     
0  131062   0        167  -0.064533   0.090540  -0.012166   0.009563   
   131895   0        168  -0.064533   0.090540  -0.012166   0.009563   
   132728   0        169  -0.064533   0.090540  -0.012166   0.009563   
   133561   0        170  -0.230583   0.488096   0.935920   0.028222   
   134393   0        171  -0.230583   0.488096   0.935920   0.028222

           derived_4  fundamental_0  fundamental_1  fundamental_2    ...     \
id                                                                   ...      
0  131062   0.130775      -0.182136       0.502698       0.169803    ...      
   131895   0.130775      -0.182136       0.502698       0.169803    ...      
   132728   0.130775      -0.182136       0.502698       0.169803    ...      
   133561  -0.083071      -0.240929       0.502698       0.212425    ...      
   134393  -0.083071      -0.240929       0.502698       0.212425    ...

           technical_36  technical_37  technical_38  technical_39  \
id                                                                  
0  131062      0.039496     -0.000043     -0.000002 -2.547840e-10   
   131895      0.039496     -0.000043     -0.000002 -2.547840e-10   
   132728      0.039496     -0.000043     -0.000002 -2.547840e-10   
   133561      0.727659      0.000000      0.000000  0.000000e+00   
   134393      0.727659      0.000000      0.000000  0.000000e+00

           technical_40  technical_41  technical_42  technical_43  \
id                                                                  
0  131062     -0.071485     -0.000941  2.955212e-38     -0.000102   
   131895     -0.071485     -0.000941  2.955212e-38     -0.000102   
   132728     -0.071485     -0.000941  2.955212e-38     -0.000102   
   133561     -0.160478     -0.000941  0.000000e+00      0.000000   
   134393     -0.160478     -0.000941  0.000000e+00      0.000000

           technical_44         y  
id                                 
0  131062     -0.013518 -0.007108  
   131895     -0.013518  0.001950  
   132728     -0.013518  0.017724  
   133561     -0.013518  0.012934  
   134393     -0.013518 -0.025229

[5 rows x 111 columns]
</pre></div>


<div class="highlight"><pre><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(id == 0) &amp; (timestamp&lt;170)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre>Index([u&#39;id&#39;, u&#39;timestamp&#39;, u&#39;technical_22&#39;, u&#39;technical_34&#39;, u&#39;y&#39;], dtype=&#39;object&#39;)
</pre></div>


<h2>3. Correlation</h2>
<h3>3.1. check the correlation between x and y in the full data</h3>
<p>numpy provide functition np.corrcoef() to calculate the pearson correlation coefficient and pandas has df.corr() to do the same thing. The better of pandas is it will handle missing values directly while numpy need to impute the missing first.</p>
<div class="highlight"><pre><span class="n">corr_d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
        <span class="n">corr_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span class="n">corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">corr_d</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span> <span class="n">corr</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="k">print</span> <span class="n">corr</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>                     0
technical_20 -0.016534
technical_27 -0.008092
technical_19 -0.007647
technical_35 -0.006009
technical_36 -0.005902
                       0
fundamental_18  0.005123
fundamental_53  0.006009
fundamental_51  0.006013
fundamental_11  0.008151
technical_30    0.014272
</pre></div>


<p>as is shown, the correlation between all x and y are not low. The most negative correlated variables are technical_20(-0.016534), tenichical_27(-0.008092); the most positive correlated variables are fundamental_18 (0.005123), fundamental_53(0.006009). The maximum correlation is less them 2%. </p>
<p>Let's have a look at within each time stamp, if there is any variables have strong correlation with y.</p>
<h3>3.2. correlation between x and y within timestamp</h3>
<p>The direct correlation between x and y is very low. However, since the data is the combination of each instrument, the intuitive think is to check the correlation of y and x within each instrument. Data can also be treated as multiple instrments at each time stamp, so another thought is to check the correlation within each timestamp.</p>
<div class="highlight"><pre><span class="n">grp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span class="n">s1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grp</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>After we sort the value, we can see that for for timestamp 679 and 359, technical_40 has the highest correlation with y; for timestamp 679, technical_7 has the highest correlation.</p>
<div class="highlight"><pre><span class="n">ssort</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)],</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">print</span> <span class="n">ssort</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="k">print</span> <span class="n">ssort</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span class="k">[[679, u&#39;technical_40&#39;, -0.61238033073603038], [359, u&#39;technical_40&#39;, -0.60861802020416578], [679, u&#39;technical_7&#39;, -0.6031429961412077], [1500, u&#39;technical_36&#39;, -0.50500188603013252], [513, u&#39;technical_20&#39;, -0.50077160906865514]]</span>


<span class="k">[[239, u&#39;fundamental_59&#39;, 0.58286085236367469], [239, u&#39;technical_22&#39;, 0.62048394512745275], [241, u&#39;technical_40&#39;, 0.64763093025619489], [239, u&#39;technical_7&#39;, 0.69531703280170543]]</span>
</pre></div>


<p>For timestamp=679, techinicatl_40 has strong negative correlation(-0.61238033073603038) with y. For stimestamp=359, it is also techinical_40 has strong negative corrleation(-0.60861802). So although overll the correlation is weak, but if we look at the data with in each timestamp group, we can find some variables that has pretty storng correlation with y.</p>
<h3>3.3. correlation between x and y within id</h3>
<p>For each instrument, we can check which variables have the highest correlation with y. This will be the correlation within each group by instrument id.</p>
<div class="highlight"><pre><span class="n">grp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span class="n">s1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grp</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>It shows the correlation between x and y within each instrument is also higher then the correlation of the full data, although it is not as strong as group by timestamp.</p>
<div class="highlight"><pre><span class="n">ssort</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)],</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span> <span class="n">ssort</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="k">print</span> <span class="n">ssort</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span class="k">[[10, u&#39;technical_5&#39;, 0.30671451385776877], [10, u&#39;technical_2&#39;, 0.20053930725042707], [10, u&#39;fundamental_61&#39;, 0.19872930349160989], [10, u&#39;fundamental_57&#39;, 0.16555170011275736], [10, u&#39;fundamental_63&#39;, 0.15923680951545652]]</span>


<span class="k">[[2158, u&#39;technical_35&#39;, -0.30463890005790334], [2158, u&#39;technical_31&#39;, -0.40696077297260669], [2158, u&#39;technical_42&#39;, nan], [2158, u&#39;technical_43&#39;, nan]]</span>
</pre></div>


<p>For instrument 10, technical_5 has positive correlation(0.306714513) with y. instrument 2158, techinical_35 has negative correlation with y. </p>
<p>So we we study each instrument independently, we still get stronger correlation than using the whole data. This information will be helpful later in building the model.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">,</span> <span class="n">methodcaller</span>
<span class="nb">sorted</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1"># sorted([list(i) + [j] for i, j in zip(s1, s2)], key=attrgetter(&#39;correlation&#39;))</span>
</pre></div>


<h3>3.4. Summary</h3>
<p>If we take the full data, the correlation between all the x and y is very weak. However, if we group the data by instrument or by the timestamp, the correlation will be stronger. </p>
<p>But can we group the data for modeling?</p>
<h2>4. Model</h2>
<h3>4.1. models on full data</h3>
<p>Since y is (capped and floored) continuous variable, the easiest model is to build the linear regression model.3 regression will be compared: linear regression, ridge regression and lasso regression. The difference between redige and lasso is in the penalty function. Ridge is two order penalty function while lasso is absolute penalty function. Thus lasso can select variables by letting these coefficients appreach 0 but ridge regression cannot.Adaboost regressor is also tested. When building classification models, adaboost is thought to be the best out of pocket model. Here in the regression models, its performance is not that better comparing to linear gression.</p>
<p>Full data has beed used without variable selection. It shows linear regression has the best mean squared errors.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">AdaBoostRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">ridge</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">()</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">Lasso</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span class="n">df</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">dfx_median</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dfx_median</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

<span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dfx_median</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

<span class="n">lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dfx_median</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">lasso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>


<span class="n">reg_ada</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">),</span> <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">reg_ada</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dfx_median</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">reg_ada</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

<span class="n">ed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span> <span class="n">ed</span><span class="o">-</span><span class="n">st</span>
</pre></div>


<p>Of course this comparison is too raw to use since we put all data as training data and compare result from the training data. Usually if you try to overfit the model, the performance on the training data will be good but the prediction power of the model will not as good as expected. We should build a model to predict the trend rather than to predict the errors from the training data.</p>
<p>To compare the model performance more reasonable, we should split the data to training data and validation data. Building model on the training data and comparing model on the validation data. </p>
<p>In the above example all variables are used in the model. In fact this is not a good way either. One consern is incaluding too many variables will cause overfitting.Generally the more variables included, better performance will the training model performance be. The second is when there are a lot of variables, some variables may be high correlated, resulting in multi-collinearity. The third thing is including too many variables will cost lots of resources to fit the model.</p>
<h3>4.2. Split to training/validation and pick 20 most related vars</h3>
<p>From the correlation between x and y we can pick the top 20 variables by the correlation with y. The full data will be split to 60% as training data and 40% as validaiton data. As we can see, the running time is much shorter than using the all the x. Linear regression is the best model. For most cases, the MSE will be lower than using all the variables in the model. </p>
<div class="highlight"><pre><span class="n">top20</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

<span class="n">dfx_median</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">dfx_median</span><span class="p">)</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">top20</span><span class="p">],</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="n">lr</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">ridge</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">Ridge</span><span class="p">()</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">Lasso</span><span class="p">()</span>

<span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">),</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">),</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">lasso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">),</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">reg_ada</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">),</span> <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">reg_ada</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">reg_ada</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">),</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">ed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span> <span class="n">ed</span><span class="o">-</span><span class="n">st</span>
</pre></div>


<div class="highlight"><pre>0.000500598917586
0.000500607067788
0.000500847186479
0.00050218493994
90.745000124
</pre></div>


<h3>4.3. model on each group</h3>
<p>Using the top 20 correlated coclumns will improve the model a little. The correlation is stronger amont the group: by instrument or by timestamp. So if building a model for each timestamp, will it improve more? </p>
<p>Let's look at the example of building the model on each timestamp and select the top 10 correlated variables.</p>
<div class="highlight"><pre><span class="n">pred_lr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pred_ridge</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pred_lasso</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">300</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">i</span>
    <span class="n">df0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;timestamp == @i&#39;</span><span class="p">)</span>
    <span class="n">df0</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="n">select_var</span> <span class="o">=</span>  <span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">corrwith</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span>
    <span class="c1">#print select_var</span>

    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

    <span class="n">pred_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">pred_lr</span><span class="p">,</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">])]</span>
    <span class="n">pred_ridge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">pred_ridge</span><span class="p">,</span> <span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">])]</span>
    <span class="n">pred_lasso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">pred_lasso</span><span class="p">,</span> <span class="n">lasso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">select_var</span><span class="p">])]</span>
</pre></div>


<div class="highlight"><pre>0
300
600
900
1200
1500
1800
</pre></div>


<div class="highlight"><pre><span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">pred_lr</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">pred_ridge</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">pred_lasso</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre>0.000414826716159
0.000419801804688
0.00048255088499
</pre></div>


<p>Above are some exploratory analysis of the data and the tentative models. The more detailed models should be built on the consideration above and the variable selection.    </p>
<h2>Reference</h2>
<ol>
<li><a href="http://stackoverflow.com/questions/14529838/apply-multiple-functions-to-multiple-groupby-columns">Apply multiple functions to multiple groupby columns</a></li>
</ol>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>